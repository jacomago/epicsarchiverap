
services:
  # Base service definitions (not intended to be run directly but serve as templates)
  mariadb-base-template:
    image: mariadb
    environment:
      MYSQL_ROOT_PASSWORD: archappl
      MYSQL_DATABASE: archappl
      MYSQL_USER: archappl
      MYSQL_PASSWORD: archappl
    volumes:
      # Common initialization scripts for all MariaDB instances
      - mariainit:/docker-entrypoint-initdb.d
    healthcheck:
      # Test command to check if MariaDB is responsive
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", "-u$$MYSQL_USER", "-p$$MYSQL_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s # Allow time for MariaDB to initialize, especially on first run

  archappl-base-template:
    build:
      context: ../ # Assuming docker-compose.yml is in the 'docker' subdirectory
      dockerfile: Dockerfile
      target: singletomcat
    environment:
      # Common environment variable, specific identity will be set per service
      ARCHAPPL_APPLIANCES: /usr/local/tomcat/archappl_conf/multipleappliances.xml
    volumes:
      # Common configuration volume
      - archapplconfig:/usr/local/tomcat/archappl_conf
    networks:
      # All archappl instances connect to the common archapplnet
      - archapplnet

  # Actual service definitions
  mariadb0:
    extends:
      service: mariadb-base-template
    hostname: mariadb0 # Unique hostname for this instance
    networks:
      # Network specific to this MariaDB and its archappl instance
      - archappl0net
    ports:
      - "3306:3306" # Expose MariaDB on host port 3306
    volumes:
      # Specific data volume for this instance (merges with volumes from base template)
      - archappldata0:/var/lib/mysql

  archappl0:
    extends:
      service: archappl-base-template
    hostname: archappl0
    networks:
      # Connects to its dedicated MariaDB network (merges with networks from base template)
      - archappl0net
    ports:
      - "8080:8080" # Expose Tomcat on host port 8080
    environment:
      # Specific identity for this appliance instance (merges with environment from base template)
      ARCHAPPL_MYIDENTITY: archappl0
    volumes:
      # Specific storage volume for this instance (merges with volumes from base template)
      - archapplstorage0:/usr/local/tomcat/storage/
    depends_on: # depends_on is not inherited by 'extends'
      mariadb0:
        condition: service_healthy # Wait for mariadb0 to be healthy

  mariadb1:
    extends:
      service: mariadb-base-template
    hostname: mariadb1
    networks:
      - archappl1net
    ports:
      - "3307:3306" # Expose MariaDB on host port 3307
    volumes:
      - archappldata1:/var/lib/mysql

  archappl1:
    extends:
      service: archappl-base-template
    hostname: archappl1
    networks:
      - archappl1net
    ports:
      - "8081:8080" # Expose Tomcat on host port 8081
    environment:
      ARCHAPPL_MYIDENTITY: archappl1
    volumes:
      - archapplstorage1:/usr/local/tomcat/storage/
    depends_on: # depends_on is not inherited by 'extends'
      mariadb1:
        condition: service_healthy

  example-ioc:
    build:
      context: . # Build context is the current directory (where docker-compose.yml is)
      dockerfile: Dockerfile.ioc
    networks:
      - archapplnet
    stdin_open: true # Keep STDIN open
    tty: true        # Allocate a pseudo-TTY
    restart: always  # Always restart the IOC if it stops
    volumes:
      # Mount test resources for the IOC
      - ioc:/usr/ioc
    command: softIocPVA -m P=test -d /usr/ioc/UnitTestPVs.db

networks:
  archapplnet:    # Common network for inter-appliance communication and IOC
  archappl0net:   # Isolated network for archappl0 and mariadb0
  archappl1net:   # Isolated network for archappl1 and mariadb1

volumes:
  archappldata0:    # Persistent data for mariadb0
  archappldata1:    # Persistent data for mariadb1
  archapplstorage0: # Persistent storage for archappl0
  archapplstorage1: # Persistent storage for archappl1
  mariainit:        # Shared SQL initialization scripts for MariaDB
    driver_opts:
      type: none
      device: ./archappl/conf/sql # Path relative to docker-compose.yml
      o: bind
  archapplconfig:   # Shared configuration files for archappl instances
    driver_opts:
      type: none
      device: ./archappl/conf     # Path relative to docker-compose.yml
      o: bind
  ioc:             # Test resources for the example-ioc
    driver_opts:
      type: none
      device: ./ioc
      o: bind